package ca.mcgill.ecse211.lab3;

import static ca.mcgill.ecse211.lab3.Resources.*;

/**
 * This class implements methods for the navigation of the robot through waypoints
 * @author Tony
 *
 */

public class Navigation implements Runnable {
  
  private static boolean navigating = false;
  
  /**
   * Run function, input waypoints here
   */
  
  public void run() {
    travelTo(3 * TILE_SIZE, 2 * TILE_SIZE );
    travelTo(2 * TILE_SIZE, 2 * TILE_SIZE );
    travelTo(2 * TILE_SIZE, 3 * TILE_SIZE );
    travelTo(3 * TILE_SIZE, 1 * TILE_SIZE );
  }
  
  /**
   * This method calculates the vehicle displacement through x/y
   * and the turning angle (theta). It then sets the rotations 
   * needed to reach the right waypoint.
   * 
   * @param x
   * @param y
   */
  
  public void travelTo(double x, double y) {
    
    double dx, dy, displacement, theta;
    double currentPosition[] = odometer.getXYT();
    
    leftMotor.stop();
    rightMotor.stop();
    leftMotor.setAcceleration(ACCELERATION);
    rightMotor.setAcceleration(ACCELERATION);
    
    navigating = true;
    
    dx = x - currentPosition[0];
    dy = y - currentPosition[1];
    displacement = Math.hypot(dx, dy);
    theta = Math.atan2(dy, dx);
    
    leftMotor.setSpeed(ROTATE_SPEED);
    rightMotor.setSpeed(ROTATE_SPEED);
    turnTo(theta);
    
    leftMotor.setSpeed(FORWARD_SPEED);
    rightMotor.setSpeed(FORWARD_SPEED);
    leftMotor.rotate(distanceToRotations(displacement));
    rightMotor.rotate(distanceToRotations(displacement));
  }
  
  /**
   * This method takes a distance and converts it to the
   * number of wheel rotations needed
   * 
   * @param distance
   * @return
   */
  
  private int distanceToRotations(double distance) {
    int rotations = (int) (180 * distance / (Math.PI * WHEEL_RAD));
    return rotations;
  }
  
  /**
   * This method makes the robot turn to the right waypoint
   * 
   * @param theta
   */
  
  public void turnTo(double theta) {
    
    leftMotor.rotate(radToDeg(turnAngle));
    rightMotor.rotate(-radToDegree(turnAngle));
    
  }
  
  /**
   * This method transforms the angle in rad to degrees
   * 
   * @param angle
   * @return
   */
  
  private int radToDeg(double angle) {
    int rotations = distanceToRotations(TRACK * angle / 2);
    return rotations;
  }
  
  /**
   * This method returns if the robot is travelling or not
   * 
   * @return
   */
  
  public boolean isNavigating() {
    return navigating;
  }
  
}
